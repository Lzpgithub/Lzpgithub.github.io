---
layout: post
title: 一个简单的TCP通信程序
categories: 计算机网络
description:  WinSock编程
keywords: WinSock
---

编写一个服务器端程序和客户端程序。服务器端程序与客户端程序的TCP连接建立后首先向客户端发送一条内容为“Connect succeed.Please send a message to me”，然后等待接收客户端发送来的一条消息，收到后显示该消息并关闭连接，继续等待其他客户的连接请求。客户程序在服务器的连接建立成功后接收并显示从服务器收到的信息，然后从键盘接收一行信息发送给服务器。

服务器程序需要完成如下工作：

(1).初始化Winsock库；

(2).创建监听套接字；

(3).填写要绑定的本地地址结构；

(4).给监听套接字绑定本地地址；

(5).让监听套接字开始监听；

(6).循环执行：调用accept()函数接收连接请求，如果accept()成功返回，则使用accept()函数返回的套接字向客户发送一条消息，然后接收客户返回的信息并显示。服务器程序依次为到达的连接请求提供服务，与一个客户通信完成后才会与另一个客户连接，如果各步操作都不发生错误，服务器程序将不会结束。这种服务器被称为**“循环服务器”**。

![](/images/posts/Intel/10.png)


客户端程序需要完成的主要工作步骤如下：

(1).初始化Winsock库；

(2).创建通信套接字；

(3).填写要连接的服务器的地址结构；

(4).与服务器建立连接；

(5).连接成功后接收一条服务器发来的信息并显示，然后向服务器发送一条信息；

(6).关闭套接字，卸载Winsock库，结束程序。

![](/images/posts/Intel/11.png)

整个过程的流程图：

![](/images/posts/Intel/12.png)

服务器端程序：

```cpp
#include <iostream>
#include "winsock2.h"
#define PORT 65432
#pragma comment(lib,"ws2_32.lib")

using namespace std;

int main(){
	/*************定义相关变量******************/
	SOCKET sock_server,newsock;       //监听套接字 已连接套接字
	struct sockaddr_in addr;          //服务器地址
	struct sockaddr_in client_addr;   //客户端地址
	char msgbuffer[256];              //接收缓冲区
	char msg[]="Connect succeed.\n";  //发送信息


	/************初始化winsock2.DLL************/
	WSADATA wsaData;
	WORD wVerionRequested=MAKEWORD(2,2);
	if(WSAStartup(wVerionRequested,&wsaData)!=0){
		cout<<"加载winsock.dll失败！";
		return 0;
	}


	/*************创建监听套接字****************/
	if((sock_server=socket(AF_INET,SOCK_STREAM,0))==SOCKET_ERROR){
		cout<<"创建套接字失败！错误代码："<<WSAGetLastError()<<endl;
		WSACleanup();
		return 0;
	}


	/***********填写绑定服务器地址**************/
	int addr_len=sizeof(struct sockaddr_in);
	memset((void *)&addr,0,addr_len);            //把地址结构体清0
	addr.sin_family=AF_INET;
	addr.sin_port=htons(PORT);
	addr.sin_addr.s_addr=htonl(INADDR_ANY);      //使用本机IP地址作为服务器地址


	/**********监听套接字绑定服务器地址*********/
	if(bind(sock_server,(struct sockaddr *)&addr,sizeof(addr))!=0){
		cout<<"地址绑定失败！错误代码："<<WSAGetLastError()<<endl;
		closesocket(sock_server);
		WSACleanup();
		return 0;
	}


	/**********将套接字设置为监听状态***********/
	if(listen(sock_server,0)!=0){
		cout<<"listen 函数调用失败！错误代码："<<WSAGetLastError()<<endl;
		closesocket(sock_server);
		WSACleanup();
		return 0;
	}else
		cout<<"listenning.....\n";


	/********循环接受连接请求并收发数据*********/
	int size;
	while(true){
		if((newsock=accept(sock_server,(struct sockaddr *)&client_addr,&addr_len))==INVALID_SOCKET){
			cout<<"accept函数调用失败！错误代码："<<WSAGetLastError()<<endl;
			break;
		}else
			cout<<"成功接收一个连接请求"<<endl;

		//成功接收一个连接以后 先发送信息
		size=send(newsock,msg,sizeof(msg),0);       //给客户端发送信息
		if(size==SOCKET_ERROR){
			cout<<"发送信息失败！错误代码："<<WSAGetLastError()<<endl;
			closesocket(newsock);
			continue;
		}else
			cout<<"发送信息成功！\n";

		if((size=recv(newsock,msgbuffer,sizeof(msgbuffer),0))<0){
			cout<<"接收信息失败！错误代码："<<WSAGetLastError()<<endl;
			closesocket(newsock);
			continue;
		}else if(size==0){
			cout<<"对方已关闭连接！\n";
			closesocket(newsock);
			continue;
		}else 
			cout<<"收到的信息为："<<msgbuffer<<endl;
		closesocket(newsock);
	}

	closesocket(sock_server);
	WSACleanup();

	system("pause");
}
```

客户端程序：

```cpp
#include <iostream>
#include "winsock2.h"
#define PORT 65432
#pragma comment(lib,"ws2_32.lib")

using namespace std;

int main(){
	/************定义相关变量*************/
	SOCKET sock_client;                          //客户端套接字
	struct sockaddr_in server_addr;              //存放服务器地址
	int addr_len=sizeof(struct sockaddr_in);
	char msgbuffer[1000];                        //接收缓冲区


	/********初始化winsock2.DLL**********/
	WSADATA wsaData;
	WORD wVerionRequested=MAKEWORD(2,2);
	if(WSAStartup(wVerionRequested,&wsaData)!=0){
		cout<<"加载winsock.dll失败！";
		return 0;
	}


	/************创建套接字**************/
	if((sock_client=socket(AF_INET,SOCK_STREAM,0))<0){
		cout<<"创建套接字失败！错误代码："<<WSAGetLastError()<<endl;
		WSACleanup();
		return 0;
	}


	/***********填写服务器地址************/
	char IP[20];
	cout<<"请输入服务器IP地址：";
	cin>>IP;
	memset((void *)&server_addr,0,addr_len);             //把地址结构体清0
	server_addr.sin_family=AF_INET;
	server_addr.sin_port=htons(PORT);
	server_addr.sin_addr.s_addr=inet_addr(IP);      


	/*********套接字与服务器连接***********/
	if(connect(sock_client,(struct sockaddr *)&server_addr,addr_len)!=0){
		cout<<"地址绑定失败！错误代码："<<WSAGetLastError()<<endl;
		closesocket(sock_client);
		WSACleanup();
		return 0;
	}


	/******循环接受连接请求并收发数据*******/
	int size;
	if((size=recv(sock_client,msgbuffer,sizeof(msgbuffer),0))<0){
		cout<<"接收信息失败！错误代码："<<WSAGetLastError()<<endl;
		closesocket(sock_client);
		return 0;
	}else if(size==0){
		cout<<"对方已关闭连接！\n";
		closesocket(sock_client);
		WSACleanup();
		return 0;
	}else 
		cout<<"从服务器收到的信息为："<<msgbuffer<<endl;

	cout<<"从键盘输入一行文字发送给服务器！\n";
	cin>>msgbuffer;
	if((size=send(sock_client,msgbuffer,sizeof(msgbuffer),0))<0){
		cout<<"发送信息失败！错误代码："<<WSAGetLastError()<<endl;
	}else if(size==0){
		cout<<"对方已关闭连接！\n";
	}else
		cout<<"信息发送成功！\n";
	

	closesocket(sock_client);
	WSACleanup();

	system("pause");
}
```

程序运行效果：

服务器端：

![](/images/posts/Intel/13.png)

客户端：

![](/images/posts/Intel/14.png)

