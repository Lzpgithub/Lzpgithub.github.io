---
layout: post
title: TCP程序设计
categories: 计算机网络
description:  WinSock编程
keywords: WinSock
---

TCP协议是一种面向连接的协议，在传输数据之前必须先建立连接，通信完成后还需要释放连接，连接的建立和释放是由通信双方相互协作共同完成的。主动发起连接建立的一端称为“客户端”，被动接收连接请求的一端被称为“服务器”。

##### TCP客户端和服务器端的交互过程

通常，服务器大都可以同时与多个客户保持连接，因此，在通信过程中，服务器端至少有两个套接字，其中有一个被称为监听套接字，该套接字由服务器程序调用socket()函数创建，专用于等待客户连接请求的到来；其余套接字则是连接建立时由系统创建的，称为已连接套接字，每当监听套接字接收到一个客户连接请求，系统就会为该连接请求创建一个新的已连接套接字，并用该套接字与客户端建立连接。以后，与客户之间的数据交换也要使用这个已连接套接字。已连接套接字绑定的IP地址来自于监听套接字，因此，与监听套接字相同。端口号则是由系统自动分配的，是系统从未使用的端口号中随机选择的。

一般，服务器进程首先启动，并等待客户端的连接建立请求，其基本通信过程如下：

(1).调用socket函数建立一个套接字，该套接字用于监听。

(2).调用bind函数为套接字绑定一个端口号和IP地址。

(3).调用listen函数，设置套接字处于监听状态。

(4).如果程序不退出，则反复执行：

a.使用accept函数等待客户机的连接到来。如果有远程计算机的连接请求到来，则用一个新的套接字(已连接套接字)建立起与客户机之间的通信连接。

b.使用recv函数和send函数利用新建的连接和客户端通信。

c.通信完毕调用closesocket函数关闭连接。

客户端程序的流程如下：

(1).用socket函数建立一个套接字，设定服务器的IP和端口。

(2).调用connect函数连接远程计算机指定的端口。

(3).使用recv函数和send函数利用新建的连接与服务器通信。

(4).通信完毕调用closesocket函数关闭连接。

流式套接字程序的服务器和客户工作流程如图：

![](/images/posts/Intel/2.png)


##### 创建套接字

创建套接字的实质就是请求操作系统分配通信所需要的一些系统资源，包括存储空间、网络资源、CPU时间等，这些资源的总和用一个称为套接字描述符的整数表示。创建套接字需要调用socket函数完成。

函数原型：SOCKET socket(int af,int type,int protocol);

函数参数：

af:标识一个地址家族，该函数的取值通常为表示TCP/IP协议地址族的常量AF_INET。

type:标识套接字类型，SOCK_STREAM表示流式套接字，SOCK_DGRAM表示数据报套接字，SOCK_RAW表示原始套接字。

protocol:用于指定套接字所用的特定协议，依赖于第2个参数type，设为0，表示使用默认的协议。

socket函数返回的套接字描述符的类型符SOCKET，它是Winsock中专门定义的一种新的数据类型，其定义为：typedef u_int SOCKET;

使用socket函数创建流式套接字可以使用如下代码：

```cpp
SOCKET sock_server;
if((sock_server=socket(AF_INET,SOCK_STREAM,0))==INVALID_SOCKET){
	cout<<"创建套接字失败！错误代码:"<<WSAGetLastError()<<endl;
	WSACleanup();
	return 0;
}
```
注意，服务程序和客户程序所创建的套接字的用处是不同，服务器创建的套接字是监听套接字，并不用于数据收发，而客户端创建的套接字则有两方面用途：一是向服务器发送连接建立请求，二是用于进行客户端的数据收发。


##### 绑定地址

socket函数在创建套接字时并没有为创建的套接字分配地址，因此服务器软件在创建了监听套接字以后，还必须为它分配一个地址，该地址为套接字指定需要监听的TCP端口号和IP地址。将套接字绑定到一个指定的地址上的套接字函数是bind()。