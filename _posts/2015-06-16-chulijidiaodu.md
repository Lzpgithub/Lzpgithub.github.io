---
layout: post
title: 处理机调度的概念
categories: 操作系统
description: 处理机调度的概念
keywords: C, 调度
---

CPU是计算机系统中一个十分重要的资源。在早期的计算机系统中，对它的管理是十分简单的。因为那是它和其他系统资源一样，为一个作业所独占，不存在处理机分配和调度问题。随着多道程序技术和各种不同类型的操作系统出现，各种不同的CPU管理方法得到启用。

不同CPU管理方法为不同用户提供不同性能的操作系统。

在多道批处理系统中，为了提高处理机的效率和增加作业吞吐率，当调度一批作业组织多道运行时，要尽可能使作业搭配合理，充分利用系统中的各种资源。

在分时系统中，由于用户使用交互式会话的工作方式，系统必须要有较快的响应时间，使得每个用户都感到如同只有它自己一人在使用这台计算机。

在实时系统中，首先要考虑的是处理机的相应时间。

由此可见，操作系统的要求不同，处理机管理策略是不同的。

#### 调度的基本概念

在多道程序系统中，进程的数量往往多于处理机的个数，进程争用处理机的情况就在所难免。**处理机调度是对处理机进行分配，就是从就绪队列中，按照一定的算法（公平、髙效）选择一个进程并将处理机分配给它运行，以实现进程并发地执行**。处理机调度是多道程序操作系统的基础，它是操作系统设计的核心问题。

#### 调度层次

一个作业从提交开始直到完成，往往要经历以下四级调度：

1) 作业调度。又称高级调度，**其主要任务是按一定的原则从外存上处于后备状态的作业中挑选一个（或多个）作业，给它（们）分配内存、输入/输出设备等必要的资源，并建立相应的进程，以使它（们）获得竞争处理机的权利**。简言之，就是内存与辅存之间的调度。对于每个作业只调入一次、调出一次。

多道批处理系统中大多配有作业调度，而其他系统中通常不需要配置作业调度。作业调度的执行频率较低，通常为几分钟一次。

2) 中级调度。又称内存调度。引入中级调度是为了**提高内存利用率和系统吞吐量**。为此，应使那些暂时不能运行的进程，调至外存等待，把此时的进程状态称为挂起状态。当它们已具备运行条件且内存又稍有空闲时，由中级调度来决定，把外存上的那些已具备运行条件的就绪进程，再重新调入内存，并修改其状态为就绪状态，挂在就绪队列上等待。

3) 进程调度。又称为低级调度，其主要任务是**按照某种方法和策略从就绪队列中选取一个进程，将处理机分配给它**。进程调度是操作系统中最基本的一种调度，在一般操作系统中都必须配置进程调度。进程调度的频率很高，一般几十毫秒一次。

4) 线程调度

**在多道批处理系统中，存在着作业调度和进程调度**。但是，**在分时系统和实时系统中，一般不存在作业调度，而只有进程调度、中级调度和线程调度**。这是因为在分时系统和实时系统中，为了缩短响应时间或为了满足用户需求的截止时间，作业不是建立在外存，而是直接建立在内存中。在这些系统中，一旦用户和系统的交互开始，用户马上要进行控制。因而，这些系统中没有作业提交状态和后备状态。它们的输入信息经过终端缓冲区为系统所接收，或者立即处理，或者经交换调度暂存外存中。

![](/images/posts/OS/45.png)

#### 三级调度的联系

作业调度从外存的后备队列中选择一批作业进入内存，为它们建立进程，这些进程被送入就绪队列，进程调度从就绪队列中选出一个进程，并把其状态改为运行状态，把CPU分配给它。中级调度是为了提高内存的利用率，系统将那些暂时不能运行的进程挂起来。当内存空间宽松时，通过中级调度选择具备运行条件的进程，将其唤醒。

1) 作业调度为进程活动做准备，进程调度使进程正常活动起来，中级调度将暂时不能运行的进程挂起，中级调度处于作业调度和进程调度之间。

2) 作业调度次数少，中级调度次数略多，进程调度频率最高。

3) 进程调度是最基本的，不可或缺。

#### 作业与进程的关系

作业可被看作是用户向计算机提交任务的**任务实体**，例如一次计算、一个控制过程等。反过来，进程则是计算机为了完成用户**任务实体**而设置的**执行实体**，是系统分配资源的基本单位。显然，计算机要完成一个任务实体，必须要有一个以上的执行实体。也就是说，**一个作业总是由一个以上的进程组成**。

作业要分解进程，系统必须为一个作业创建一个根进程。然后，在执行作业控制语句时，根据任务要求，系统或根进程为其创建相应的子进程，然后，为各子进程分配资源和调度各子进程执行以完成作业要求的任务。

#### 作业调度

作业调度主要是完成作业从后备状态到执行状态的转变，以及从执行状态到完成状态的转变。

作业调度功能：

(1).记录系统中各作业的状况，包括执行阶段的有关情况。

(2).从后备队列中挑选出一部分作业投入执行。一般来说，系统中处于后备状态的作业较多，大的系统可以达到几十个甚至几百个，这取决于输入井的空间大小。但是，处于执行状态的作业一般只有有限的几个。**作业调度程序根据选定的调度算法，从后备作业队列中挑选出若干作业投入执行**。

(3).为被选中作业做好执行前的准备工作。**作业调度程序为选中的作业建立相应的进程，并为这些进程分配它们所需要的系统资源**，如分配它们的内存、外存、外设等。

(4).在作业执行结束时做善后处理工作。主要是输出作业管理信息，例如执行时间等。再就是回收该作业所占用的资源，撤销与该作业有关的全部进程和该作业的作业控制块。

#### 进程调度

无论是在批处理系统、分时系统还是实时系统，**用户进程数一般都多于处理机数，这将导致用户进程互相争夺处理机**。另外，系统进程也同样需要使用处理机。这就要求进程调度程序要按一定的策略，动态的把处理机分配给处于就绪队列中的某一个进程，以使之执行。

进程调度的具体功能：

1.记录系统中所有进程的执行情况。

2.选择占有处理机的进程。进程调度的主要功能是按照一定的策略选择一个处于就绪状态的进程，使其获得处理机执行。

3.进行进程上下文切换。当正在执行的进程由于某种原因要让出处理机时，系统要做上下文切换，以使被调度选中的进程得以执行。被选中的进程执行时，必须从上一次被中断处开始执行，这就要恢复该进程上下文和进行上下文切换。系统要保留有关被切换进程的足够信息，以便以后切换回该进程时，顺利恢复该进程的执行。在系统保留了CPU现场之后，调度程序选择一个新的处于就绪状态的进程，并装配成该进程的上下文，使CPU的控制权转换到被选中的进程中。


#### 调度的时机、切换与过程

进程调度和切换程序是操作系统内核程序。当请求调度的事件发生后，才可能会运行进程调度程序，当调度了新的就绪进程后，才会去进行进程间的切换。理论上这三件事情应该顺序执行，但在实际设计中，在操作系统内核程序运行时，如果某时发生了引起进程调度的因素，并不一定能够马上进行调度与切换。

现代操作系统中，不能进行进程的调度与切换的情况有以下几种情况。

1) 在处理中断的过程中：中断处理过程复杂，在实现上很难做到进程切换，而且中断处理是系统工作的一部分，逻辑上不属于某一进程，不应被剥夺处理机资源。

2) 进程在操作系统内核程序临界区中：进入临界区后，需要独占式地访问共享数据，理论上必须加锁，以防止其他并行程序进入，在解锁前不应切换到其他进程运行，以加快该共享数据的释放。

3) 其他需要完全屏蔽中断的原子操作过程中：如加锁、解锁、中断现场保护、恢复等原子操作。在原子过程中，连中断都要屏蔽，更不应该进行进程调度与切换。

如果在上述过程中发生了引起调度的条件，并不能马上进行调度和切换，应置系统的请求调度标志，直到上述过程结束后才进行相应的调度与切换。

应该进行进程调度与切换的情况有：

1) 当发生引起调度条件，且当前进程无法继续运行下去时，可以马上进行调度与切换。如果操作系统只在这种情况下进行进程调度，就是非剥夺调度。 

2) 当中断处理结束或自陷处理结束后，返回被中断进程的用户态程序执行现场前，若置上请求调度标志，即可马上进行进程调度与切换。如果操作系统支持这种情况下的运行调度程序，就实现了剥夺方式的调度。

进程切换往往在调度完成后立刻发生，它要求保存原进程当前切换点的现场信息，恢复被调度进程的现场信息。现场切换时，操作系统内核将原进程的现场信息推入到当前进程的内核堆栈来保存它们，并更新堆栈指针。内核完成从新进程的内核栈中装入新进程的现场信息、更新当前运行进程空间指针、重设PC寄存器等相关工作之后，开始运行新的进程。


#### 进程调度方式

所谓进程调度方式是指当某一个进程正在处理机上执行时，若有某个更为重要或紧迫的进程需要处理，即有优先权更髙的进程进入就绪队列，此时应如何分配处理机。

通常有以下两种进程调度方式：

1) 非剥夺调度方式，又称非抢占方式。是指当一个进程正在处理机上执行时，即使有某个更为重要或紧迫的进程进入就绪队列，仍然让正在执行的进程继续执行，直到该进程完成或发生某种事件而进入阻塞状态时，才把处理机分配给更为重要或紧迫的进程。

在非剥夺调度方式下，**一旦把CPU分配给一个进程，那么该进程就会保持CPU直到终止或转换到等待状态**。这种方式的优点是实现简单、系统开销小，适用于大多数的批处理系统，但它不能用于分时系统和大多数的实时系统。

2) 剥夺调度方式，又称抢占方式。是指当一个进程正在处理机上执行时，若有某个更为重要或紧迫的进程需要使用处理机，则立即暂停正在执行的进程，将处理机分配给这个更为重要或紧迫的进程。.

**釆用剥夺式的调度，对提高系统吞吐率和响应效率都有明显的好处**。但“剥夺”不是一种任意性行为，必须遵循一定的原则，主要有：优先权、短进程优先和时间片原则等。

#### 调度的基本准则

不同的调度算法具有不同的特性，在选择调度算法时，必须考虑算法所具有的特性。为了比较处理机调度算法的性能，人们提出很多评价准则，下面介绍主要的几种：

1) CPU利用率。CPU是计算机系统中最重要和昂贵的资源之一，所以应尽可能使CPU 保持“忙”状态，使这一资源利用率最髙。

2) 系统吞吐量。表示单位时间内CPU完成作业的数量。长作业需要消耗较长的处理机时间，因此会降低系统的吞吐量。而对于短作业，它们所需要消耗的处理机时间较短，因此能提高系统的吞吐量。调度算法和方式的不同，也会对系统的吞吐量产生较大的影响。

3) 周转时间。是指从作业提交到作业完成所经历的时间，包括作业等待、在就绪队列中排队、在处迤机上运行以及进行输入/输出操作所花费时间的总和。

作业的周转时间可用公式表示如下：

**周转时间 = 作业完成时间 - 作业提交时间**

平均周转时间是指多个作业周转时间的平均值：

**平均周转时间 = (作业1的周转时间 + ... + 作业 n 的周转时间) / n**

带权周转时间是指作业周转时间与作业实际运行时间的比值：

![](/images/posts/OS/46.png)

平均带权周转时间是指多个作业带权周转时间的平均值：

**平均带权周转时间 = (作业1的带权周转时间 + ... + 作业 n 的带权周转时间) / n**

4) 等待时间。是指进程处于等处理机状态时间之和，等待时间越长，用户满意度越低。处理机调度算法实际上并不影响作业执行或输入/输出操作的时间，只影响作业在就绪队列中等待所花的时间。因此，衡量一个调度算法优劣常常只需简单地考察等待时间。

5) 响应时间。是指从用户提交请求到系统首次产生响应所用的时间。在交互式系统中，周转时间不可能是最好的评价准则，一般釆用响应时间作为衡量调度算法的重要准则之一。从用户角度看，调度策略应尽量降低响应时间，使响应时间处在用户能接受的范围之内。

要想得到一个满足所有用户和系统要求的算法几乎是不可能的。设计调度程序，一方面要满足特定系统用户的要求（如某些实时和交互进程快速响应要求)，另一方面要考虑系统整体效率（如减少整个系统进程平均周转时间），同时还要考虑调度算法的开销。
